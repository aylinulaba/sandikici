---
import BaseLayout from "../layouts/BaseLayout.astro";
import fs from "node:fs/promises";

const posts = await Astro.glob("../../content/posts/*.md");

posts.sort((a, b) => {
  const da = new Date(a.frontmatter?.date ?? 0).getTime();
  const db = new Date(b.frontmatter?.date ?? 0).getTime();
  return db - da;
});

const toSlug = (file) => file.split("/").pop().replace(".md", "");

function makeExcerptFromMarkdown(md, max = 220) {
  // Frontmatter'ı at
  const withoutFm = md.replace(/^---[\s\S]*?---\s*/m, "");

  // Markdown'ı kaba şekilde text'e indir
  const text = withoutFm
    .replace(/!\[[^\]]*\]\([^)]+\)/g, "") // img
    .replace(/\[[^\]]*\]\([^)]+\)/g, "") // link
    .replace(/`{1,3}[\s\S]*?`{1,3}/g, "") // inline/fenced code (kaba)
    .replace(/^#{1,6}\s+/gm, "") // headings
    .replace(/[*_~>#-]/g, "") // md işaretleri
    .replace(/\s+/g, " ")
    .trim();

  if (!text) return "";

  return text.length > max ? text.slice(0, max).trimEnd() + "…" : text;
}

const items = await Promise.all(
  posts.map(async (post) => {
    const slug = toSlug(post.file);
    const md = await fs.readFile(post.file, "utf-8");
    const excerpt = makeExcerptFromMarkdown(md, 200);
    return { post, slug, excerpt };
  })
);
---

<BaseLayout>
  <ul class="archive">
    {items.map(({ post, slug, excerpt }) => (
      <li class="archive-item">
        <a class="title" href={`/blog/${slug}`}>{post.frontmatter.title}</a>

        {excerpt ? <p class="excerpt">{excerpt}</p> : null}

        <a class="readmore" href={`/blog/${slug}`}>Oku →</a>
      </li>
    ))}
  </ul>
</BaseLayout>